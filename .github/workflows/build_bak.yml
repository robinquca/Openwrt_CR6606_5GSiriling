name: Build OpenWrt Firmware

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses-dev zlib1g-dev gawk git gettext libssl-dev xsltproc wget unzip python3 subversion ninja-build

      - name: Clone OpenWrt
        run: |
          git clone --depth 1 --branch openwrt-21.02 https://github.com/immortalwrt/immortalwrt.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Add 5G-Modem-Support & missing packages
        run: |
          git clone https://github.com/Siriling/5G-Modem-Support.git openwrt/package/5G-Modem-Support
          sudo apt install -y minify

      - name: Patch gn to fix redundant-move error
        run: |
          mkdir -p openwrt/feeds/packages/devel/gn/patches
          cat <<EOF > openwrt/feeds/packages/devel/gn/patches/100-remove-redundant-move.patch
          --- a/src/gn/desc_builder.cc
          +++ b/src/gn/desc_builder.cc
          @@ -167,7 +167,7 @@
          base::Value ToBaseValue(const std::vector<T>& list) {
          base::ListValue res;
          for (const auto& val : list)
          res.Append(ToBaseValue(val));
          -  return std::move(res);
          +  return res;
          }

          base::Value ToBaseValue(const Scope* scope) {
          @@ -176,7 +176,7 @@
          for (const auto& pair : scope->values()) {
          res.SetStringKey(pair.first, pair.second.Describe(true));
          }
          -  return std::move(res);
          +  return res;
          }
          EOF

      - name: Copy custom .config
        run: cp .config openwrt/

      - name: Build OpenWrt firmware
        run: |
          cd openwrt
          make defconfig
          make -j$(nproc)

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-bin
          path: openwrt/bin/
